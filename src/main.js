const { app, BrowserWindow, session, Menu, MenuItem, dialog } = require('electron');
const { autoUpdater } = require('electron-updater');
const path = require('path');

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Refer√™ncia global da janela principal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let mainWindow = null;

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Cria janela principal ou pop‚Äëup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function createWindow(url = null) {
  mainWindow = new BrowserWindow({
    width: 1280,
    height: 800,
    title: `Chat EBHC v${app.getVersion()}`,
    icon: path.join(__dirname, '../assets/icon.ico'),
    autoHideMenuBar: true,
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
      contextIsolation: true,
      nodeIntegration: false,
      webviewTag: true
    }
  });

  url ? mainWindow.loadURL(url)
      : mainWindow.loadFile(path.join(__dirname, 'index.html'));

  mainWindow.on('closed', () => { mainWindow = null; });

  return mainWindow;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Menu de contexto ‚ÄúSalvar imagem como‚Ä¶‚Äù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function attachSaveImageMenu(contents) {
  contents.on('context-menu', (_e, params) => {
    if (params.mediaType === 'image' && params.srcURL) {
      const menu = new Menu();
      menu.append(
        new MenuItem({
          label: 'Salvar imagem como‚Ä¶',
          click: () => contents.downloadURL(params.srcURL)
        })
      );

      const win = BrowserWindow.fromWebContents(contents) || BrowserWindow.getFocusedWindow();
      menu.popup({ window: win });
    }
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Ativa menu em todos os webContents + trata window.open ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
app.on('web-contents-created', (_e, c) => {
  attachSaveImageMenu(c);
  c.setWindowOpenHandler(({ url }) => (createWindow(url), { action: 'deny' }));
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Di√°logo ‚ÄúSalvar como‚Ä¶‚Äù para downloads ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function wireDownloads() {
  session.defaultSession.on('will-download', (_e, item, wc) => {
    const win = BrowserWindow.fromWebContents(wc);
    const out = dialog.showSaveDialogSync(win, {
      title: 'Salvar arquivo',
      defaultPath: item.getFilename()
    });
    out ? item.setSavePath(out) : item.cancel();
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Auto‚Äëupdate com tela de progresso ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function initAutoUpdate() {
  let updateWindow = null;

  autoUpdater.autoDownload = true;
  autoUpdater.autoInstallOnAppQuit = true;

  autoUpdater.on('checking-for-update', () => {
    console.log('üîé Verificando nova vers√£o...');
  });

  autoUpdater.on('update-available', info => {
    console.log(`‚¨áÔ∏è Baixando v${info.version}...`);

    updateWindow = new BrowserWindow({
      width: 400,
      height: 200,
      resizable: false,
      minimizable: false,
      maximizable: false,
      closable: false,
      title: 'Atualizando...',
      frame: true,
      alwaysOnTop: true,
      center: true,
      icon: path.join(__dirname, '../assets/icon.ico'),
      webPreferences: { contextIsolation: true }
    });

    updateWindow.loadURL(`data:text/html,
      <html>
        <body style="display:flex;justify-content:center;align-items:center;height:100%;font-family:sans-serif;">
          <h2>Atualizando app... aguarde</h2>
        </body>
      </html>`);
  });

  autoUpdater.on('update-downloaded', info => {
    console.log(`‚úÖ v${info.version} baixada ‚Äì instalar√° na pr√≥xima abertura`);
    if (updateWindow) updateWindow.close();
  });

  autoUpdater.on('error', err => {
    console.error('‚ö†Ô∏è Erro no auto-update:', err);
    if (updateWindow) updateWindow.close();
  });

  autoUpdater.checkForUpdatesAndNotify();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ App pronto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
app.whenReady().then(() => {
  wireDownloads();
  createWindow();     // cria a janela principal
  initAutoUpdate();   // verifica atualiza√ß√µes
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Boilerplate mac / Win ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') app.quit();
});
app.on('activate', () => {
  if (BrowserWindow.getAllWindows().length === 0) createWindow();
});
